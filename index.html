<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>新闻页懒加载瀑布流布局</title>
    <script src="https://cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
    <style>
        * {
            padding: 0;
            margin: 0;
            box-sizing: border-box;
        }
        main {
            width: 900px;
            margin: 0 auto;
        }
        .single-news {
            width: 280px;
            margin: 10px;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .news-preview {
            width: 100%;
        }
        .news-message>dt {
            margin: 10px 0 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ccc;
            font-weight: bold;
        }
        .news-message>dl {
            font-size: 12px;
            line-height: 1.8;
            color: #777371;
        }
    </style>
</head>
<body>
    <main>
        <div class="single-news">
            <img class="news-preview" src="http://n.sinaimg.cn/tech/transform/200/w600h400/20180508/rKBJ-hacuuvu7966137.jpg">
            <div class="news-message">
                <dt>欧空局发布迄今为止最详细星图</dt>
                <dl>欧空局近日发布了银河系及邻近星系的最详细版星图，其中包含对近17亿颗恒星的高精度测量数据。</dl>
            </div>
        </div>
    </main>
</body>
<script>
    // 1.获取图片
    // 2.瀑布流方式渲染
    // 3.滚动到底部加载新的图片
    var width = $('.single-news').outerWidth(true),
        maxWidth = $('main').width(),
        col = Math.floor(maxWidth / width);
        clientHeightArr = [];
    for(var i=0;i<col;i++) {
        clientHeightArr.push(0);
    }

    function getData() {
        $.ajax({

        }).done(function(res){
            if(res && res.status && res.status.code==='0') {
                handleData(res.data);
            } else {
                console.log('数据获取失败');
            }
        })
    }

    function handleData(data) {
        // 1.用数据生成节点
        // 2.将节点用瀑布流的方式渲染上去
        $.each(data, function(index, news) {
            var $node = getNode(news);
            $node.find('img').load(function() {
                waterFallRender($node);
            })
        })
    }

    function getNode(data) {
        var node = '\n' +
            '        <div class="single-news">\n' +
            '            <a href="' + data.url + '"><img class="news-preview" src="' + data.img_url + '"></a>\n' +
            '            <div class="news-message">\n' +
            '                <dt>' + data.short_name + '</dt>\n' +
            '                <dl>' + data.short_intro + '</dl>\n' +
            '            </div>\n' +
            '        </div>';
        return $(node);
    }

    function waterFallRender($node) {
        // 1.先计算列数
        // 2.找到高度最小值的列数，放入
        var minIndex = findMin(clientHeightArr);
        $node.css({
            position: 'absolute',
            top: clientHeightArr[minIndex],
            left: minIndex.width
        });
        clientHeightArr[minIndex] += $node.height();
    }

    function findMin(arr) {
        var minIndex = 0,
            minValue = arr[0];
        for(var i=1;i<arr.length;i++) {
            if(minValue>arr[i]) {
                minIndex = i;
                minValue = arr[i];
            }
        }
        return minIndex;
    }

</script>
<script>



    //1. 获取数据
    //2. 把数据变为 Dom，通过瀑布流的方式放到页面上
    //3. 当滚动到底部的时候， --》 1

    var curPage = 1
    var perPageCount = 10
    var colSumHeight = []
    var nodeWidth = $('.item').outerWidth(true)
    var colNum = parseInt($('#pic-ct').width()/nodeWidth)
    for(var i = 0; i < colNum.length; i++){
        colSumHeight[i] = 0
    }

    var isDataArrive = true

    start()

    function start(){

        getData(function(newsList){
            console.log(newsList)
            isDataArrive = true
            $.each(newsList, function(idx, news){
                var $node = getNode(news)
                $node.find('img').load(function(){
                    $('#pic-ct').append($node)
                    console.log($node, 'loaded...')
                    waterFallPlace($node)
                })
            })
        })
        isDataArrive = false
    }



    $(window).scroll(function(){
        if(!isDataArrive) return

        if(isVisible($('#load'))){
            start()
        }
    })


    function getData(callback){
        $.ajax({
            url: 'http://platform.sina.com.cn/slide/album_tech',
            dataType: 'jsonp',
            jsonp:"jsoncallback",
            data: {
                app_key: '1271687855',
                num: perPageCount,
                page: curPage
            }
        }).done(function(ret){
            if(ret && ret.status && ret.status.code === "0"){
                callback(ret.data);   //如果数据没问题，那么生成节点并摆放好位置
                curPage++
            }else{
                console.log('get error data');
            }
        });
    }


    function getNode(item){
        var tpl = ''
        tpl += '<li class="item">';
        tpl += ' <a href="'+ item.url +'" class="link"><img src="' + item.img_url + '" alt=""></a>';
        tpl += ' <h4 class="header">'+ item.short_name +'</h4>';
        tpl += '<p class="desp">'+item.short_intro+'</p>';
        tpl += '</li>';

        return $(tpl)
    }

    function waterFallPlace($node){

        var idx = 0,
                minSumHeight = colSumHeight[0];

        for(var i=0;i<colSumHeight.length; i++){
            if(colSumHeight[i] < minSumHeight){
                idx = i;
                minSumHeight = colSumHeight[i];
            }
        }

        $node.css({
            left: nodeWidth*idx,
            top: minSumHeight,
            opacity: 1
        });

        colSumHeight[idx] = $node.outerHeight(true) + colSumHeight[idx];
        $('#pic-ct').height(Math.max.apply(null,colSumHeight));

    }

    function isVisible($el){
        var scrollH = $(window).scrollTop(),
                winH = $(window).height(),
                top = $el.offset().top;

        if(top < winH + scrollH){
            return true;
        }else{
            return false;
        }
    }






    /*



     var clock;
     $(window).on('scroll', function(){
     //用户鼠标滚轮滚动一次，有多次事件响应。下面的 setTimeout 主要是为性能考虑，只在最后一次事件响应的时候执行 checkshow
     if(clock){
     clearTimeout(clock);
     }
     clock = setTimeout(function(){
     checkShow();
     }, 100);
     });

     // 用户第一次打开页面，还未滚动窗口的时候需要执行一次 checkShow
     checkShow();

     */

    function checkShow(){
        if(isShow($('#load'))){
            loadAndPlace();
        }
    }

    function isShow($el){
        var scrollH = $(window).scrollTop(),
                winH = $(window).height(),
                top = $el.offset().top;

        if(top < winH + scrollH){
            return true;
        }else{
            return false;
        }
    }



    // 获取数据，并且摆放位置

    var curPage = 1,
            perPageCount = 9;

    function loadAndPlace(){
        $.ajax({
            url: 'http://platform.sina.com.cn/slide/album_tech',
            dataType: 'jsonp',   //这里使用了新浪新闻的 jsonp 接口，大家可以直接看数据， 如： http://platform.sina.com.cn/slide/album_tech?jsoncallback=func&app_key=1271687855&num=3&page=4
            jsonp:"jsoncallback",
            data: {
                app_key: '1271687855',
                num: perPageCount,
                page: curPage
            }
        }).done(function(ret){
            if(ret && ret.status && ret.status.code === "0"){
                place(ret.data);   //如果数据没问题，那么生成节点并摆放好位置
                curPage++
            }else{
                console.log('get error data');
            }
        });
    }



    function place(nodeList){
        console.log(nodeList);
        $.each(nodeList, function(index,item){
            var $node = getNode(item)
            $node.find('img').load(function(){
                $('#pic-ct').append($node)
                waterFallPlace($node)
            })
        })

        /*

         var $nodes = renderData(nodeList);  //节点生成后添加到页面上

         var defereds = [];  //创建存储 defered 对象的数组
         $nodes.find('img').each(function(){
         var defer = $.Deferred();
         $(this).load(function(){
         defer.resolve();
         });   //当每个图片加载完成后，执行 resolve
         defereds.push(defer);
         });
         $.when.apply(null,defereds).done(function() { //当所有的图片都执行 resolve 后，即全部图片加载后，执行下面的内容
         console.log('new images all loaded ...');
         //当节点里的图片全部加载后再使用瀑布流计算，否则会因为图片未加载 item 高度计算错误导致瀑布流高度计算出问题
         waterFallPlace($nodes);
         });
         */
    }



    // 瀑布流

    var colSumHeight = [],
            nodeWidth = $('.item').outerWidth(true),
            colNum = parseInt($('#pic-ct').width()/nodeWidth);

    for(var i=0; i<colNum; i++){
        colSumHeight.push(0)
    }

    function waterFallPlace($nodes){
        $nodes.each(function(){
            var $cur = $(this);
            //colSumHeight = [100, 250, 80, 200]

            var idx = 0,
                    minSumHeight = colSumHeight[0];

            for(var i=0;i<colSumHeight.length; i++){
                if(colSumHeight[i] < minSumHeight){
                    idx = i;
                    minSumHeight = colSumHeight[i];
                }
            }

            $cur.css({
                left: nodeWidth*idx,
                top: minSumHeight,
                opacity: 1
            });

            colSumHeight[idx] = $cur.outerHeight(true) + colSumHeight[idx];
            $('#pic-ct').height(Math.max.apply(null,colSumHeight));
        });

    }



    function getNode(item){
        var tpl = ''
        tpl += '<li class="item">';
        tpl += ' <a href="'+ item.url +'" class="link"><img src="' + item.img_url + '" alt=""></a>';
        tpl += ' <h4 class="header">'+ item.short_name +'</h4>';
        tpl += '<p class="desp">'+item.short_intro+'</p>';
        tpl += '</li>';

        return $(tpl)
    }


    function renderData(items){
        var tpl = '',
                $nodes;
        for(var i = 0;i<items.length;i++){
            tpl += '<li class="item">';
            tpl += ' <a href="'+ items[i].url +'" class="link"><img src="' + items[i].img_url + '" alt=""></a>';
            tpl += ' <h4 class="header">'+ items[i].short_name +'</h4>';
            tpl += '<p class="desp">'+items[i].short_intro+'</p>';
            tpl += '</li>';
        }
        $nodes = $(tpl);
        $('#pic-ct').append($nodes);
        return $nodes;
    }


</script>
</html>